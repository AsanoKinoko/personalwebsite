<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!-- Design Tokens -->
    <link rel="stylesheet" href="../assets/css/admin/design-tokens.css">
    <!-- Layout -->
    <link rel="stylesheet" href="../components/layout/AdminLayout.css">
    <!-- UI Components -->
    <link rel="stylesheet" href="../components/ui/Button/Button.css">
    <link rel="stylesheet" href="../components/ui/Badge/Badge.css">
    <link rel="stylesheet" href="../components/ui/StatCard/StatCard.css">
    <link rel="stylesheet" href="../components/ui/Input/Input.css">
    <!-- Feedback States -->
    <link rel="stylesheet" href="../components/feedback/LoadingState.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .dashboard-section {
            margin-bottom: var(--spacing-xl);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: #f1c232;
            text-shadow: 1px 1px 4px rgba(255, 242, 204, 0.5);
            margin-bottom: var(--spacing-lg);
        }

        .quick-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            width: 100%;
            max-width: 100%;
        }

        .page-header h1 {
            color: #f1c232;
            text-shadow: 1px 1px 4px rgba(255, 242, 204, 0.5);
        }

        .page-header p {
            color: #fff2cc;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Admin Layout -->
    <div id="adminLayoutContainer"></div>

    <script>
        let analyticsData = null;

        // Load analytics data
        function loadAnalyticsData() {
            return fetch('../data/analytics/analytics-data.json')
                .then(res => res.json())
                .then(data => {
                    analyticsData = data;
                    return data;
                })
                .catch(err => {
                    console.error('Error loading analytics data:', err);
                    return null;
                });
        }

        // Format number
        function formatNumber(num) {
            if (!num) return '0';
            return new Intl.NumberFormat('vi-VN').format(num);
        }

        // Render dashboard content
        function renderDashboard(data) {
            const metadata = data?.metadata || {};
            const returningRate = data?.returningRate || 0;

            return `
                <div class="page-header">
                    <h1 class="heading-1" style="color: #f1c232; text-shadow: 1px 1px 4px rgba(255, 242, 204, 0.5);">Dashboard</h1>
                    <p class="body-text" style="color: #fff2cc; opacity: 0.9;">Tổng quan về website và hoạt động</p>
                </div>

                <div class="dashboard-section">
                    <h2 class="section-title">Tổng quan</h2>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <h3 class="stat-card-title">Tổng lượt truy cập</h3>
                                <div class="stat-card-icon primary">
                                    <i class='bx bx-trending-up'></i>
                                </div>
                            </div>
                            <div class="stat-card-value">${formatNumber(metadata.totalVisits || 0)}</div>
                            <div class="stat-card-footer">
                                <span class="stat-card-description">Tổng số lượt truy cập</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-card-header">
                                <h3 class="stat-card-title">Người dùng duy nhất</h3>
                                <div class="stat-card-icon success">
                                    <i class='bx bx-user'></i>
                                </div>
                            </div>
                            <div class="stat-card-value">${formatNumber(metadata.uniqueVisitors || 0)}</div>
                            <div class="stat-card-footer">
                                <span class="stat-card-description">Số người dùng duy nhất</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-card-header">
                                <h3 class="stat-card-title">Tổng pageviews</h3>
                                <div class="stat-card-icon info">
                                    <i class='bx bx-file'></i>
                                </div>
                            </div>
                            <div class="stat-card-value">${formatNumber(metadata.totalPageviews || 0)}</div>
                            <div class="stat-card-footer">
                                <span class="stat-card-description">Tổng số lượt xem trang</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-card-header">
                                <h3 class="stat-card-title">Tỷ lệ quay lại</h3>
                                <div class="stat-card-icon warning">
                                    <i class='bx bx-refresh'></i>
                                </div>
                            </div>
                            <div class="stat-card-value">${returningRate ? returningRate.toFixed(1) : '0.0'}%</div>
                            <div class="stat-card-footer">
                                <span class="stat-card-description">Tỷ lệ người dùng quay lại</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section">
                    <h2 class="section-title">Thao tác nhanh</h2>
                    <div class="quick-actions">
                        <a href="access-analytics.html" class="btn btn-primary">
                            <i class='bx bx-bar-chart-alt-2'></i>
                            Xem phân tích truy cập
                        </a>
                        <a href="../index.html" class="btn btn-outline" target="_blank">
                            <i class='bx bx-link-external'></i>
                            Xem website
                        </a>
                    </div>
                </div>
            `;
        }

        // Initialize page
        Promise.all([
            fetch('../components/layout/AdminLayout.html').then(res => res.text()),
            loadAnalyticsData()
        ]).then(([layoutHtml, data]) => {
            document.getElementById('adminLayoutContainer').innerHTML = layoutHtml;
            
            // Set active nav
            const navLink = document.querySelector('[data-nav="dashboard"]');
            if (navLink) {
                navLink.classList.add('active');
                const analyticsLink = document.querySelector('[data-nav="analytics"]');
                if (analyticsLink) {
                    analyticsLink.classList.remove('active');
                }
            }

            // Set breadcrumbs
            const breadcrumbs = document.getElementById('headerBreadcrumbs');
            if (breadcrumbs) {
                breadcrumbs.innerHTML = `
                    <a href="dashboard.html" style="color: #ededed; text-decoration: none;">Dashboard</a>
                `;
            }

            // Set page content
            const content = document.getElementById('adminContent');
            if (content) {
                if (data) {
                    content.innerHTML = renderDashboard(data);
                } else {
                    content.innerHTML = `
                        <div class="page-header">
                            <h1 class="heading-1" style="color: #f1c232; text-shadow: 1px 1px 4px rgba(255, 242, 204, 0.5);">Dashboard</h1>
                            <p class="body-text" style="color: #fff2cc; opacity: 0.9;">Tổng quan về website và hoạt động</p>
                        </div>
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class='bx bx-bar-chart-alt-2'></i>
                            </div>
                            <h3 class="empty-state-title">Chưa có dữ liệu</h3>
                            <p class="empty-state-description">Dữ liệu analytics sẽ được hiển thị khi có lượt truy cập được ghi nhận.</p>
                        </div>
                    `;
                }
            }

            // Initialize sidebar toggle
            initAdminLayout();
        }).catch(err => {
            console.error('Error initializing dashboard:', err);
            const content = document.getElementById('adminContent');
            if (content) {
                content.innerHTML = `
                    <div class="error-state">
                        <div class="error-state-icon">
                            <i class='bx bx-error-circle'></i>
                        </div>
                        <h3 class="error-state-title">Đã xảy ra lỗi khi tải dữ liệu</h3>
                        <p class="error-state-description">Vui lòng kiểm tra kết nối hoặc thử lại sau.</p>
                        <div class="error-state-actions">
                            <button class="btn btn-primary" onclick="location.reload()">
                                <i class='bx bx-refresh'></i>
                                Thử lại
                            </button>
                        </div>
                    </div>
                `;
            }
        });

        function initAdminLayout() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('adminSidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                });
            }

            if (mobileMenuBtn && sidebar && sidebarOverlay) {
                mobileMenuBtn.addEventListener('click', () => {
                    sidebar.classList.add('mobile-open');
                    sidebarOverlay.classList.add('active');
                });

                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.remove('mobile-open');
                    sidebarOverlay.classList.remove('active');
                });
            }
        }
    </script>
</body>
</html>